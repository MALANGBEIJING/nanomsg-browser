"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}(),nanomsg={REQ:"rep.sp.nanomsg.org",PAIR:"pair.sp.nanomsg.org",SUB:"pub.sp.nanomsg.org"};nanomsg.Socket=function(){function e(n){_classCallCheck(this,e),this.protocol=n,this.wss=new Map,this.reqIdHeader=null,this.cbs={data:[]},this.handleMessage=this.handleMessage.bind(this),this.protocol==nanomsg.REQ&&(this.reqIdHeader=new Uint8Array(4),window.crypto.getRandomValues(this.reqIdHeader))}return _createClass(e,[{key:"handleMessage",value:function(e){var n=this,o=new FileReader;o.addEventListener("loadend",function(){var e=o.result;n.protocol==nanomsg.REQ&&(e=e.substr(4)),n.cbs.data.forEach(function(n){return n(e)})}),o.readAsText(e.data)}},{key:"connect",value:function(e){var n=this;if(!this.wss.has(e)){console.log("nanomsg connect to: "+e);var o=new WebSocket(e,[this.protocol]);o.onopen=function(){console.log("nanomsg connected: "+e),n.wss.set(e,o)},o.onmessage=this.handleMessage,o.onerror=function(e){console.log("nanomsg error",e)},o.onclose=function(){console.log("nanomsg close: "+o.url),n.wss.has(o.url)&&n.wss.delete(o.url)}}}},{key:"bind",value:function(){throw new Error("WHOAAAA!!! Nice try, but NO, we do not support these!")}},{key:"on",value:function(e,n){var o=this.cbs[e];o&&o.push(n)}},{key:"send",value:function(e){if(this.protocol===nanomsg.SUB)throw new Exception("SUB socket can not send");if(this.protocol===nanomsg.REQ){var n=new Uint8Array(e.length+4);n.set(this.reqIdHeader,0);for(var o=4;o<e.length+4;++o)n[o]=e.charCodeAt(o-4);e=n}var t=!0,s=!1,r=void 0;try{for(var a,l=this.wss.values()[Symbol.iterator]();!(t=(a=l.next()).done);t=!0){var c=a.value;1===c.readyState?c.send(e):c.readyState>1&&(this.wss.has(c.url)&&this.wss.delete(c.url),console.log("nanomsg: could not send, because of closed connection ("+c.url+")"))}}catch(e){s=!0,r=e}finally{try{!t&&l.return&&l.return()}finally{if(s)throw r}}}}]),e}();