"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function n(n,e){for(var o=0;o<e.length;o++){var t=e[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}return function(e,o,t){return o&&n(e.prototype,o),t&&n(e,t),e}}(),nanomsg={debug:!1,reconnectTime:1e3,REQ:"rep.sp.nanomsg.org",PAIR:"pair.sp.nanomsg.org",SUB:"pub.sp.nanomsg.org"};nanomsg.Socket=function(){function n(e){_classCallCheck(this,n),this.protocol=e,this.wss=new Map,this.reqIdHeader=null,this.cbs={data:[]},this.handleMessage=this.handleMessage.bind(this),this.protocol==nanomsg.REQ&&(this.reqIdHeader=new Uint8Array(4),window.crypto.getRandomValues(this.reqIdHeader))}return _createClass(n,[{key:"handleMessage",value:function(n){var e=this,o=new FileReader;o.addEventListener("loadend",function(){var n=o.result;e.protocol==nanomsg.REQ&&(n=n.substr(4)),e.cbs.data.forEach(function(e){return e(n)})}),o.readAsText(n.data)}},{key:"connect",value:function(n){var e=this;if(!this.wss.has(n)){nanomsg.debug&&console.log("nanomsg connect to: "+n);var o=new WebSocket(n,[this.protocol]);o.initialUrl=n,this.wss.set(n,o),o.onopen=function(){nanomsg.debug&&console.log("nanomsg connected: "+n)},o.onmessage=this.handleMessage,o.onerror=function(n){nanomsg.debug&&console.log("nanomsg error",n)},o.onclose=function(){nanomsg.debug&&console.log("nanomsg close: "+o.initialUrl),e.wss.has(o.initialUrl)&&setTimeout(function(){nanomsg.debug&&console.log("nanomsg reconnect: "+o.initialUrl),e.wss.delete(o.initialUrl),e.connect(o.initialUrl)},nanomsg.reconnectTime)}}}},{key:"disconnect",value:function(n){var e=this.wss.get(n);e&&(this.wss.delete(n),e.close())}},{key:"bind",value:function(){throw new Error("WHOAAAA!!! Nice try, but NO, we do not support these!")}},{key:"on",value:function(n,e){var o=this.cbs[n];o&&o.push(e)}},{key:"send",value:function(n){if(this.protocol===nanomsg.SUB)throw new Exception("SUB socket can not send");if(this.protocol===nanomsg.REQ){var e=new Uint8Array(n.length+4);e.set(this.reqIdHeader,0);for(var o=4;o<n.length+4;++o)e[o]=n.charCodeAt(o-4);n=e}var t=!0,s=!1,a=void 0;try{for(var r,i=this.wss.values()[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var l=r.value;1===l.readyState?l.send(n):l.readyState>1&&(this.wss.has(l.url)&&this.wss.delete(l.url),nanomsg.debug&&console.log("nanomsg: could not send, because of closed connection ("+l.url+")"))}}catch(n){s=!0,a=n}finally{try{!t&&i.return&&i.return()}finally{if(s)throw a}}}}]),n}();