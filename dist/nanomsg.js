"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function n(n,e){for(var o=0;o<e.length;o++){var t=e[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}return function(e,o,t){return o&&n(e.prototype,o),t&&n(e,t),e}}(),nanomsg={debug:!1,reconnectTime:1e3,REQ:"rep.sp.nanomsg.org",PAIR:"pair.sp.nanomsg.org",SUB:"pub.sp.nanomsg.org"};nanomsg.Socket=function(){function n(e){_classCallCheck(this,n),this.protocol=e,this.wss=new Map,this.reqIdHeader=null,this.promise=null,this.cbs={data:[]},this.protocol==nanomsg.REQ&&(this.reqIdHeader=new Uint8Array(4),window.crypto.getRandomValues(this.reqIdHeader),this.reqIdHeader[0]|=128)}return _createClass(n,[{key:"connect",value:function(n){var e=this;if(!this.wss.has(n)){nanomsg.debug&&console.log("nanomsg connect to: "+n);var o=new WebSocket(n,[this.protocol]);o.initialUrl=n,this.wss.set(n,o),o.onopen=function(){nanomsg.debug&&console.log("nanomsg connected: "+n)},o.onmessage=function(n){var o=new FileReader;o.addEventListener("loadend",function(){var n=o.result;e.promise&&(e.promise.resolve(n),e.promise=null),e.cbs.data.forEach(function(e){return e(n)})}),e.protocol==nanomsg.REQ?o.readAsText(n.data.slice(4)):o.readAsText(n.data)},o.onerror=function(n){nanomsg.debug&&console.log("nanomsg error",n)},o.onclose=function(){nanomsg.debug&&console.log("nanomsg close: "+o.initialUrl),e.wss.has(o.initialUrl)&&setTimeout(function(){nanomsg.debug&&console.log("nanomsg reconnect: "+o.initialUrl),e.wss.delete(o.initialUrl),e.connect(o.initialUrl)},nanomsg.reconnectTime)}}}},{key:"disconnect",value:function(n){var e=this.wss.get(n);e&&(this.wss.delete(n),e.close())}},{key:"bind",value:function(){throw new Error("WHOAAAA!!! Nice try, but NO, we do not support these!")}},{key:"on",value:function(n,e){var o=this.cbs[n];o&&o.push(e)}},{key:"send",value:function(n){var e=this;if(this.protocol===nanomsg.SUB)throw new Exception("SUB socket can not send");if(this.protocol===nanomsg.REQ){var o=new Uint8Array(n.length+4);o.set(this.reqIdHeader,0);for(var t=4;t<n.length+4;++t)o[t]=n.charCodeAt(t-4);n=o}nanomsg.debug&&console.log("nanomsg send =>",n);var s=!0,r=!1,a=void 0;try{for(var i,l=this.wss.values()[Symbol.iterator]();!(s=(i=l.next()).done);s=!0){var c=i.value;1===c.readyState?c.send(n):c.readyState>1&&(this.wss.has(c.url)&&this.wss.delete(c.url),nanomsg.debug&&console.log("nanomsg: could not send, because of closed connection ("+c.url+")"))}}catch(n){r=!0,a=n}finally{try{!s&&l.return&&l.return()}finally{if(r)throw a}}if(this.protocol===nanomsg.REQ||this.protocol===nanomsg.PAIR)return new Promise(function(n,o){e.promise={resolve:n,reject:o}})}}]),n}();